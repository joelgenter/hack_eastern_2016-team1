<!DOCTYPE html>
<html>
    <head>
        <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
        <meta charset="utf-8">
        <title>Test Dots</title>
        <script type="text/javascript">
            function init() {
                var renderStack = [],
                    canvas = document.getElementById("canvas"),
                    ctx = canvas.getContext("2d"),
                    mouse = {},
                    keysDown = {
                        37: false,
                        38: false,
                        39: false,
                        40: false
                    },
                    playerId = 2123,
                    then = Date.now(),
                    players = {
                        p2123: {
                            x: 23,
                            y: 45,
                            id: 2123,
                            mousex: 99,
                            mousey: 102
                        },
                    };
                var socket = io();

                socket.on('initializePlayer', function(data) {
                    console.log("data " + data);
                    playerId = data.id;
                    players[playerId] = data;
                    main();
                });

                // TODO: update otherPlayers
                var main = function () {
                    socket.emit('playerTransfer', players[playerId]);
                    var now = Date.now();
                    var delta = now - then;

                    update(delta / 1000);
                    render(renderStack);

                    then = now;

                    requestAnimationFrame(main);
                };

                socket.on('playerTransfer', function(playerObj) {
                    players[playerObj.id] = playerObj;
                 });

                addEventListener("mousemove", function (event) {
                    var mousePos = getMousePos(ctx, event);
                });

                // Render this player
                renderStack.push();

                function getMousePos(canvas, evt) {
                    players[playerId].mousex = evt.clientX;
                    players[playerId].mousey = evt.clientY;
                }

                addEventListener("keydown", function (key) {
                    if (
                        key.keyCode == 38 ||
                        key.keyCode == 40 ||
                        key.keyCode == 37 ||
                        key.keyCode == 39
                    ) {
                        keysDown[key.keyCode] = true;
                    }
                });

                addEventListener("keyup", function (key) {
                    if (
                        key.keyCode == 38 ||
                        key.keyCode == 40 ||
                        key.keyCode == 37 ||
                        key.keyCode == 39
                    ) {
                        keysDown[key.keyCode] = false;
                    }
                });

                // Update game objects
                function update (modifier) {
                	if (keysDown[38]) { // Player holding up
                		players[playerId].y -= players[playerId].speed * modifier;
                	}
                	if (keysDown[40]) { // Player holding down
                		players[playerId].y += players[playerId].speed * modifier;
                	}
                	if (keysDown[37]) { // Player holding left
                		players[playerId].x -= players[playerId].speed * modifier;
                	}
                	if (keysDown[39]) { // Player holding right
                		players[playerId].x += players[playerId].speed * modifier;
                	}
                };

                function render (stack) {
                    clear(ctx,"#eee");
                    for (var i = 0; i < stack.length; i++) {
                        stack[i]();
                    }
                }

                function clear(context, color) {
                    var tmp = context.fillStyle;
                    context.fillStyle = color;
                    context.fillRect(1, 0, context.canvas.width, context.canvas.height);
                    context.fillStyle = tmp;
                }


            }
        </script>
    </head>
    <body onload="init();">
        <canvas id="canvas" width="500" height="500"></canvas>

    </body>
</html>
